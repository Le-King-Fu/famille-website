generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION ====================

enum UserRole {
  ADMIN
  MEMBER
  CHILD
}

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  password              String
  firstName             String
  lastName              String
  role                  UserRole  @default(MEMBER)
  isActive              Boolean   @default(true)
  mustChangePassword    Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastLoginAt           DateTime?

  // Contact fields
  phone                 String?   // Format: +1-XXX-XXX-XXXX
  phoneType             String?   // "cell" | "home" | "work" | "other"
  phone2                String?   // Format: +1-XXX-XXX-XXXX
  phone2Type            String?   // "cell" | "home" | "work" | "other"
  phone3                String?   // Format: +1-XXX-XXX-XXXX
  phone3Type            String?   // "cell" | "home" | "work" | "other"
  address               String?   // Adresse libre
  avatarUrl             String?   // Placeholder pour photo future
  privacyConsentAt      DateTime? // Date consentement Loi 25

  // Relations
  events                Event[]
  albums                Album[]
  photos                Photo[]
  topics                Topic[]
  replies               Reply[]
  gameScores            GameScore[]
  photoComments         PhotoComment[]
  reactions             Reaction[]
  invitationCodesUsed   InvitationCode? @relation("UsedBy")
  invitationCodesCreated InvitationCode[] @relation("CreatedBy")
  eventRsvps            EventRsvp[]
  topicReads            TopicRead[]
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsCreated  Notification[] @relation("NotificationCreator")
  hiddenEvents          EventHiddenFrom[] @relation("HiddenEvents")
  pushSubscriptions     PushSubscription[]
  notificationPreferences NotificationPreference[]
}

model SecurityQuestion {
  id        String   @id @default(cuid())
  question  String
  answer    String   // Stored lowercase, trimmed for comparison
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecurityAttempt {
  id           String    @id @default(cuid())
  ipAddress    String
  type         String    @default("security")
  attempts     Int       @default(0)
  blockedUntil DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([ipAddress, type])
}

model InvitationCode {
  id          String    @id @default(cuid())
  code        String    @unique
  isUsed      Boolean   @default(false)
  usedAt      DateTime?
  expiresAt   DateTime
  createdAt   DateTime  @default(now())

  // Relations
  createdById String
  createdBy   User      @relation("CreatedBy", fields: [createdById], references: [id])
  usedById    String?   @unique
  usedBy      User?     @relation("UsedBy", fields: [usedById], references: [id])
}

// ==================== CALENDAR ====================

enum EventCategory {
  BIRTHDAY
  REUNION
  VACATION
  HOLIDAY
  OTHER
}

enum RsvpStatus {
  ATTENDING
  MAYBE
  NOT_ATTENDING
}

model Event {
  id          String        @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean       @default(false)
  category    EventCategory @default(OTHER)
  color       String?
  imageUrl    String?       // URL image (Supabase Storage) - ADMIN ONLY
  recurrence  Json?         // RecurrenceRule stored as JSON
  location    String?       // Venue/address
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  createdById String
  createdBy   User          @relation(fields: [createdById], references: [id])
  topicId     String?       @unique
  topic       Topic?        @relation(fields: [topicId], references: [id], onDelete: SetNull)
  rsvps       EventRsvp[]
  hiddenFrom  EventHiddenFrom[]
}

model EventRsvp {
  id        String     @id @default(cuid())
  status    RsvpStatus
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  eventId   String
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
}

model EventHiddenFrom {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("HiddenEvents", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

// ==================== PHOTOS ====================

model Album {
  id          String   @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdById  String
  createdBy    User     @relation(fields: [createdById], references: [id])
  photos       Photo[]
  coverPhotoId String?
}

model Photo {
  id           String   @id @default(cuid())
  url          String
  thumbnailUrl String
  caption      String?
  takenAt      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  albumId      String
  album        Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  tags         PersonTag[]
  comments     PhotoComment[]
}

model PersonTag {
  id      String @id @default(cuid())
  name    String
  photoId String
  photo   Photo  @relation(fields: [photoId], references: [id], onDelete: Cascade)
}

model PhotoComment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  photoId   String
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  reactions Reaction[]
}

// ==================== FORUM ====================

model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  topics      Topic[]
}

model Topic {
  id          String    @id @default(cuid())
  title       String
  content     String
  isPinned    Boolean   @default(false)
  isEdited    Boolean   @default(false)
  editedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastReplyAt DateTime  @default(now())

  // Relations
  categoryId    String
  category      ForumCategory  @relation(fields: [categoryId], references: [id])
  authorId      String
  author        User           @relation(fields: [authorId], references: [id])
  replies       Reply[]
  reactions     Reaction[]
  event         Event?
  reads         TopicRead[]
  notifications Notification[]
}

model TopicRead {
  id         String   @id @default(cuid())
  lastReadAt DateTime @default(now())

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId String
  topic   Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
}

model Reply {
  id        String    @id @default(cuid())
  content   String
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  topicId       String
  topic         Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  authorId      String
  author        User    @relation(fields: [authorId], references: [id])
  quotedReplyId String?
  quotedReply   Reply?  @relation("QuotedReplies", fields: [quotedReplyId], references: [id])
  quotedBy      Reply[] @relation("QuotedReplies")
  reactions     Reaction[]
  history       ReplyHistory[]
  notifications Notification[]
}

model ReplyHistory {
  id        String   @id @default(cuid())
  content   String
  editedAt  DateTime @default(now())

  // Relations
  replyId   String
  reply     Reply    @relation(fields: [replyId], references: [id], onDelete: Cascade)
}

// ==================== GAMES ====================

enum GameType {
  PIANO_HERO
  PIANO_HERO_V2
  WITCH_CASE
  BELLE_BETE_SAGE
  TETE_DE_SOCCER
}

model GameScore {
  id        String   @id @default(cuid())
  game      GameType
  score     Int
  metadata  Json?    // difficult√©, personnage, niveau, etc.
  playedAt  DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  MENTION        // Someone mentioned you with @Name
  QUOTE          // Someone quoted your reply
  TOPIC_REPLY    // Someone replied to your topic
  NEW_EVENT      // A new calendar event was created
}

model Notification {
  id          String           @id @default(cuid())
  type        NotificationType
  message     String           // Display text
  link        String           // URL to navigate to
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  // Relations
  userId      String           // Recipient
  user        User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  createdById String?          // Who triggered the notification
  createdBy   User?            @relation("NotificationCreator", fields: [createdById], references: [id], onDelete: SetNull)
  topicId     String?
  topic       Topic?           @relation(fields: [topicId], references: [id], onDelete: Cascade)
  replyId     String?
  reply       Reply?           @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

// ==================== PUSH NOTIFICATIONS ====================

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreference {
  id          String           @id @default(cuid())
  type        NotificationType
  pushEnabled Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
}

// ==================== REACTIONS ====================

model Reaction {
  id             String        @id @default(cuid())
  emoji          String
  createdAt      DateTime      @default(now())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId        String?
  topic          Topic?        @relation(fields: [topicId], references: [id], onDelete: Cascade)
  replyId        String?
  reply          Reply?        @relation(fields: [replyId], references: [id], onDelete: Cascade)
  photoCommentId String?
  photoComment   PhotoComment? @relation(fields: [photoCommentId], references: [id], onDelete: Cascade)

  @@unique([userId, emoji, topicId])
  @@unique([userId, emoji, replyId])
  @@unique([userId, emoji, photoCommentId])
  @@index([topicId])
  @@index([replyId])
  @@index([photoCommentId])
}
